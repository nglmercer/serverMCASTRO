---
import Layout from '../layouts/Layout.astro';
import StepForm from '@components/newserver/StepForm.astro'
import Step1 from '@components/newserver/steps/Step1.astro';
import Step2 from '@components/newserver/steps/Step2.astro';
import Step3 from '@components/newserver/steps/Step3.astro';
const steps = [
 { name: "Nombre del servidor", value: "server-name" },
 { name: "Seleccionar núcleo del servidor", value: "server-core" },
 { name: "Configuración Final", value: "final-config" }
];
---
<Layout>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="/materialSymbols.css"/>
<link rel="stylesheet" href="/src/components/newserver/steps/step.css">
<script src="/src/components/newserver/newserver.js"></script>
<script src="/src/globalSignals.ts"></script>
<task-notifications id="notificaciones"></task-notifications>
<StepForm steps={steps} title="Crear un nuevo Servidor de Minecraft">
<Step1 />
<Step2 />
<Step3 />
</StepForm>
</Layout>
<script>
import { serverapi } from "src/fetch/fetchapi";
import generateNewServerStart from "@components/newserver/startscript";
const formElemNames = [
  "serverName",
  "selecttab",
  "coreName",
  "coreVersion",
  "filecoreupload",
  "javaVersion",
  "Ramsize",
  "serverPort",
  "optiflags"
];

const formElements: Element[] = [];
const formOBJ: Record<string, any> = {};

// Función para establecer valores en formOBJ
function setValue(id: string, value: any) {
  formOBJ[id] = value;
}

// Función para configurar listeners en elementos
function setListeners(element: Element, id: string) {
  element.addEventListener('change', (e) => {
    const data = (e as CustomEvent).detail;
    console.log(data);
    if (!data || !data.value) return;
    setValue(id, data.value);
  });
}

// Inicializar elementos y configurar listeners
formElemNames.forEach((id) => {
  const element = document.getElementById(id);
  if (!element) {
    console.warn(`Elemento con ID '${id}' no encontrado`);
    return;
  }
  
  formElements.push(element);
  
  // Verifica si el elemento tiene la propiedad 'value' antes de usarla
  if ('value' in element) {
    setValue(id, (element as any).value);
  }
  
  setListeners(element, id);
});

// Manejador del evento de envío del formulario
document.addEventListener('formSubmit', async function(e) {
  formElemNames.forEach((id) => {
    const element = document.getElementById(id);
    if (!element) return;
    
    if ('value' in element) {
      setValue(id, (element as any).value);
    }
  });
  //startParameters is optimization === default string if (optiflags) 
  const params = ["serverName", "coreName", "coreVersion", "startParameters", "javaVersion", "serverPort", "fileName", "formOBJ"]
  formOBJ.startParameters = generateNewServerStart(formOBJ.Ramsize, formOBJ.optiflags);
  console.log(formOBJ);
  console.log(formElements);
  console.log(window.selecttab);

  const result = await serverapi.postNewserver(formOBJ);
  console.log(result);
});
</script>